<html>
<head>

<title>CasperJS Renderer</title>

<script language="javascript" type="text/javascript"><!--

// ---------------------------------------------------------------------------
// CasperRenderer -- a class to render recorded tests to a CasperJS
// test format.
// ---------------------------------------------------------------------------

if (typeof(EventTypes) == "undefined") {
  EventTypes = {};
}

EventTypes.OpenUrl = 0;
EventTypes.Click = 1;
EventTypes.Change = 2;
EventTypes.Comment = 3;
EventTypes.Submit = 4;
EventTypes.CheckPageTitle = 5;
EventTypes.CheckPageLocation = 6;
EventTypes.CheckTextPresent = 7;
EventTypes.CheckValue = 8;
EventTypes.CheckValueContains = 9;
EventTypes.CheckText = 10;
EventTypes.CheckHref = 11;
EventTypes.CheckEnabled = 12;
EventTypes.CheckDisabled = 13;
EventTypes.CheckSelectValue = 14;
EventTypes.CheckSelectOptions = 15;
EventTypes.CheckImageSrc = 16;
EventTypes.PageLoad = 17;
EventTypes.ScreenShot = 18;

function CasperRenderer(document) {
  this.document = document;
  this.title = "Testcase";
  this.items = null;
  this.history = new Array();
  this.screen_id = 1;
}

CasperRenderer.prototype.text = function(txt) {
  // todo: long lines
  this.document.writeln(txt);
}

CasperRenderer.prototype.stmt = function(text) {
  this.document.writeln(text);
}

CasperRenderer.prototype.cont = function(text) {
  this.document.writeln("    ... " + text);
}

CasperRenderer.prototype.pyout = function(text) {
  this.document.writeln("    " + text);
}

CasperRenderer.prototype.pyrepr = function(text) {
  // todo: handle non--strings & quoting
  return "'" + text + "'";
}

CasperRenderer.prototype.space = function() {
  this.document.write("\n");
}

var d = {};
d[EventTypes.OpenUrl] = "openUrl";
d[EventTypes.Click] = "click";
d[EventTypes.Change] = "change";
d[EventTypes.Comment] = "comment";
d[EventTypes.Submit] = "submit";
d[EventTypes.CheckPageTitle] = "checkPageTitle";
d[EventTypes.CheckPageLocation] = "checkPageLocation";
d[EventTypes.CheckTextPresent] = "checkTextPresent";
d[EventTypes.CheckValue] = "checkValue";
d[EventTypes.CheckText] = "checkText";
d[EventTypes.CheckHref] = "checkHref";
d[EventTypes.CheckEnabled] = "checkEnabled";
d[EventTypes.CheckDisabled] = "checkDisabled";
d[EventTypes.CheckSelectValue] = "checkSelectValue";
d[EventTypes.CheckSelectOptions] = "checkSelectOptions";
d[EventTypes.CheckImageSrc] = "checkImageSrc";
d[EventTypes.PageLoad] = "pageLoad";
d[EventTypes.ScreenShot] = "screenShot";
CasperRenderer.prototype.dispatch = d;

var cc = EventTypes;

CasperRenderer.prototype.render = function() {
  var etypes = EventTypes;
  this.document.open();
  this.document.write("<" + "pre" + ">");
  this.writeHeader();

  for (var i=0; i < this.items.length; i++) {
    var item = this.items[i];
    if (item.type == etypes.Comment)
      this.space();
    if (this.dispatch[item.type]) {
      // Special case: we want to ignore submit events if they came from
      // a click of a submit button, since we can just use the click in
      // the Casper. If the last event was not a button click, we assume
      // that the submit must have come from some funny javascript or 
      // or something and include the submit event.
      if ((i > 0) && (item.type == etypes.Submit)) {
        var last = this.items[i - 1];
        if (last.type == etypes.Click) {
          if ((last.info.type == "submit") || (last.info.type == "image")) {
            continue;
          }
        }
      }
      this[this.dispatch[item.type]](item);
    }
    if (item.type == etypes.Comment)
      this.space();
  }
  this.writeFooter();
  this.document.write("<" + "/" + "pre" + ">");
  this.document.close();
}

CasperRenderer.prototype.writeHeader = function() {
  var date = new Date();
  this.text("//==============================================================================");
  this.text("// Casper generated " + date);
  this.text("//==============================================================================");
  this.space();
  this.stmt("var x = require('casper').selectXPath;");
  this.stmt("var casper = require('casper').create(");
  this.stmt("	  {viewportSize:");
  this.stmt("	       {width: 1280, height: 768}");
  this.stmt("});");
  this.stmt("//Be able to select links by inner text produces more stable");
  this.stmt("//testcases. We inject it in a custom property, so CSS selectors can be used.");
  this.stmt("casper.on('load.finished', function() {");
  this.stmt("   casper.evaluate(function() {");
  this.stmt("       var links = document.querySelectorAll('a');");
  this.stmt("       for(var i=0;i&lt;links.length;i++) {links[i].setAttribute('data-text', links[i].innerText);}");
  this.stmt("   });");
  this.stmt("});");

}
CasperRenderer.prototype.writeFooter = function() {
	  this.space();
	  this.stmt("casper.run(function() {this.test.renderResults(true);});");
	}
CasperRenderer.prototype.rewriteUrl = function(url) {
  return url;
}

CasperRenderer.prototype.shortUrl = function(url) {
  return url.substr(url.indexOf('/', 10), 999999999);
}

CasperRenderer.prototype.openUrl = function(item) {
  var url = this.pyrepr(this.rewriteUrl(item.url));
  var history = this.history;
  // if the user apparently hit the back button, render the event as such
  if (url == history[history.length - 2]) {
	  this.stmt('casper.then(function() {');
	  this.stmt('    this.back();');
	  this.stmt('});');
	  history.pop();
	  history.pop();
  } else {
	  if(history.length > 0) {
		  this.stmt("casper.thenOpen(" + url + ");");
	  } else {
		  this.stmt("casper.start(" + url + ");");		  
	  }
  }
}

CasperRenderer.prototype.pageLoad = function(item) {
  var url = this.pyrepr(this.rewriteUrl(item.url));
  this.history.push(url);
}

CasperRenderer.prototype.normalizeWhitespace = function(s) {
  return s.replace(/^\s*/, '').replace(/\s*$/, '').replace(/\s+/g, ' ');
}

CasperRenderer.prototype.getControl = function(item) {
  var type = item.info.type;
  var selector;
  if ((type == "submit" || type == "button") && item.info.value)
    selector = 'input[type='+type+'][value='+this.pyrepr(this.normalizeWhitespace(item.info.value))+']';
  else if (item.info.name)
	selector = 'input[name='+this.pyrepr(item.info.name)+']';
  else if (item.info.id)
	selector = 'input#'+item.info.name;
  else
	selector = 'TODO';

  return selector;
}
	
CasperRenderer.prototype.getControlXPath = function(item) {
  var type = item.info.type;
  var way;
  if ((type == "submit" || type == "button") && item.info.value)
    way = '@value=' + this.pyrepr(this.normalizeWhitespace(item.info.value));
  else if (item.info.name)
    way = '@name=' + this.pyrepr(item.info.name);
  else if (item.info.id)
	way = '@id=' + this.pyrepr(item.info.id);
  else
    way = 'TODO';

  return way;
}

CasperRenderer.prototype.getLink = function(item) {
  var selector;
  if (item.text)
	selector = 'a[data-text='+this.pyrepr(this.normalizeWhitespace(item.text))+']';
  else if (item.info.id)
	selector = 'a#'+item.info.id;
  else if (item.info.href)
	selector = 'a[href='+this.pyrepr(this.shortUrl(item.info.href))+']'
  else if (item.info.title)
    selector = 'a[title='+this.pyrepr(this.normalizeWhitespace(item.info.title))+']';
  else 
	selector = 'TODO';

  return selector;
}

CasperRenderer.prototype.getLinkXPath = function(item) {
  var way;
  if (item.text)
    way = 'text()=' + this.pyrepr(this.normalizeWhitespace(item.text));
  else if (item.info.id)
    way = '@id=' + this.pyrepr(item.info.id);
  else if (item.info.href)
    way = '@href=' + this.pyrepr(this.shortUrl(item.info.href));
  else if (item.info.title)
    way = 'title='+this.pyrepr(this.normalizeWhitespace(item.info.title));
  else 
    way = 'TODO';

  return way;
}
	
CasperRenderer.prototype.click = function(item) {
  var tag = item.info.tagName.toLowerCase();
  var selector;
  if (tag == 'a') {
    selector = this.getLink(item);
  } else if (tag == 'input' || tag == 'button') {
	selector = this.getFormSelector(item) + ' ' + this.getControl(item);
  }
  this.stmt('casper.then(function() {');
  this.stmt('    this.test.assertExists("'+ selector + '");');
  this.stmt('    this.click("'+ selector + '");');
  this.stmt('});');
}

CasperRenderer.prototype.getFormSelector = function(item) {
	var info = item.info;
	if(!info.form) {
		return 'form';
	}
	if(info.form.id) {
		return "form#" + info.form.id;
	} else if(info.form.name) {
		return "form[name=" + info.form.name + "]";
	} else {
		return "form";
	}
}

CasperRenderer.prototype.change = function(item) {
  var type = item.info.type;
  var way = this.getControlXPath(item);
  var value = this.pyrepr(item.info.value)
  this.stmt('casper.then(function() {');
  this.stmt('    this.fill("' + this.getFormSelector(item) + '", {"' + item.info.name + '": "'+ item.info.value +'"});');
  this.stmt('});');
}

CasperRenderer.prototype.submit = function(item) {
  // the submit has been called somehow (user, or script)
  // so no need to trigger it.
  this.stmt("// submit form");
}

CasperRenderer.prototype.screenShot = function(item) {
  this.stmt('casper.then(function() {');
  this.stmt('    this.captureSelector("screenshot'+this.screen_id+'.png", "html");');
  this.stmt('});');
  this.screen_id = this.screen_id + 1;
}

CasperRenderer.prototype.comment = function(item) {
	var lines = item.text.split('\n');
	this.stmt('casper.then(function() {');
	for (var i=0; i < lines.length; i++) {
	  this.stmt('    this.test.comment("'+lines[i]+'");');
	}
	this.stmt('});');
}

CasperRenderer.prototype.checkPageTitle = function(item) {
  var title = this.pyrepr(item.title);
  this.stmt('casper.then(function() {');
  this.stmt('    this.test.assertTitle('+ title +');');
  this.stmt('});');
}

CasperRenderer.prototype.checkPageLocation = function(item) {
  var url = item.url.replace(new RegExp('/', 'g'), '\\/');
  this.stmt('casper.then(function() {');
  this.stmt('    this.test.assertUrlMatch(/^'+ url +'$/);');
  this.stmt('});');
}

CasperRenderer.prototype.checkTextPresent = function(item) {
  this.stmt('casper.then(function() {');
  this.stmt('    this.test.assertTextExists(' + this.pyrepr(item.text) + ');')
  this.stmt('});');
}

CasperRenderer.prototype.checkValue = function(item) {
  var type = item.info.type;
  var way = this.getControlXPath(item);
  if (type == 'checkbox' || type == 'radio') {
    var selected;
    if (item.info.checked)
      selected = '@checked'
    else
      selected = 'not(@checked)'
    this.stmt('casper.then(function() {');
    this.stmt('    this.test.assertExists(x("//input[' + way + ' and ' +selected+ ']"));');
    this.stmt('});');
  }
  else {
    var value = this.pyrepr(item.info.value)
    var tag = item.info.tagName.toLowerCase();
    this.stmt('casper.then(function() {');
    this.stmt('    this.test.assertExists(x("//'+tag+'[' + way + ' and @value='+value+']"));');
    this.stmt('});');
  }
}

CasperRenderer.prototype.checkText = function(item) {
  if ((item.info.type == "submit") || (item.info.type == "button")) {
    this.stmt('casper.then(function() {');
    this.stmt('    this.test.assertExists(x("//input[@value='+this.pyrepr(item.text)+']"));');
    this.stmt('});');
  }
  else {
    this.stmt('casper.then(function() {');
    this.stmt('    this.test.assertTextExists(' + this.pyrepr(item.text) + ');')
    this.stmt('});');
  }
}

CasperRenderer.prototype.checkHref = function(item) {
	var selector = this.getLinkXPath(item);
	var href = this.pyrepr(this.shortUrl(item.info.href));
    this.stmt('casper.then(function() {');
    this.stmt('    this.test.assertExists(x("//a[' + way + ' and @href='+ href +']"));');
    this.stmt('});');
}

CasperRenderer.prototype.checkEnabled = function(item) {
	  var way = this.getControlXPath(item);
	  var tag = item.info.tagName.toLowerCase();
	  this.stmt('casper.then(function() {');
	  this.stmt('    this.test.assertExists(x("//'+tag+'[' + way + ' and not(@disabled)]"));');
	  this.stmt('});');
}

CasperRenderer.prototype.checkDisabled = function(item) {
  var way = this.getControlXPath(item);
  var tag = item.info.tagName.toLowerCase();
  this.stmt('casper.then(function() {');
  this.stmt('    this.test.assertExists(x("//'+tag+'[' + way + ' and @disabled]"));');
  this.stmt('});');
}

CasperRenderer.prototype.checkSelectValue = function(item) {
  var value = this.pyrepr(item.info.value);
  var way = this.getControlXPath(item);
  this.stmt('casper.then(function() {');
  this.stmt('    this.test.assertExists(x("//select[' + way + ']/options[@selected and @value='+value+']"));');
  this.stmt('});');
}

CasperRenderer.prototype.checkSelectOptions = function(item) {
	this.stmt('// TODO');
}

CasperRenderer.prototype.checkImageSrc = function(item) {
	var src = this.pyrepr(this.shortUrl(item.info.src));
	this.stmt('casper.then(function() {');
	this.stmt('    this.test.assertExists(x("//img[@src=' + src + ']"));');
	this.stmt('});');
}

var dt = new CasperRenderer(document);
function onpageload() {
    chrome.extension.sendRequest({action: "get_items"}, function(response) {
        dt.items = response.items;
        dt.render();
    });
}
//--></script>
</head>
<body onload="onpageload()"></body>
</html>
